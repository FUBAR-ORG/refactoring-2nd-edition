# 리팩터링 정의

## 2.1 리팩터링 정의

명사: 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법   
동사: 동작은 그대로 유지한 채, 여러가지 리팩터링 기법을 적용해서 소프트웨어를 재구성하다.

특정한 방식에 따라 코드를 정리하는 것만이 리팩터링이다.   
**리팩터링하다가 코드가 깨지거나 정상 작동하지 않는다는 것은 리팩터링을 한 것이 아니다!**

##### 리팩터링과 성능 최적화
리팩터링의 목적: 코드를 이해하고 수정하기 쉽게 만드는 것   
> 성능은 신경쓰지 않기에 성능은 좋아질 수도, 나빠질 수도 있다.   

성능 최적화의 목적: 속도 개선
> 성능만을 목표로 코드를 작성하다 보면, 코드를 다루기 더 어렵게 바뀔 수도 있다.

## 2.3 리팩터링하는 이유

- 소프트웨어 설계가 좋아진다
  - 단기 목표만을 위해 코드를 수정하다 보면 기반 구조가 무너지기 쉽다.
  - 설계 파악이 어려워질수록 유지보수가 어렵고 부패속도 증가한다.
> 규칙적인 리팩터링은 코드의 구조를 지탱해준다.  
- 소프트웨어를 이해하기 쉬워진다.
  - 프로그래밍은 컴퓨터와 대화하는 것과 같다.
  - 컴퓨터에게 시키려는 일과 이를 표현한 코드의 차이를 최대한 줄여야 한다.
> 동료 혹은 미래의 나를 위해 코드의 의도를 명확하게 전달하도록 만들자.
- 버그를 쉽게 찾을 수 있다.
> 코드를 이해하기 쉽다는 말은 버그를 찾기 쉽다는 말이기도 하다.
- 프로그래밍 속도를 높일 수 있다.
> 내부 설계가 잘 된 소프트웨어는 새로운 기능을 추가할 지점과 어떻게 고칠지 쉽게 찾을 수 있다.

## 2.4 언제 리팩터링해야 할까?

- **3의 법칙**
    - 처음에는 그냥 하라
    - 비슷한 일을 두 번째로 하게 되면, 일단 적용하고, 비슷한 부분을 찾아서 리팩터링하라
    - 비슷한 일을 세 번째 하게 되면, 리팩터링하라

- 준비를 위한 리팩터링: 기능을 쉽게 추가하게 만들기
  - 리팩터링하기 가장 좋은 시점은 코드베이스에 기능을 새로 추가하기 직전이다.
> 100km를 이동하려는데 숲이 가로막고 있다면, 좀 둘러가더라도 20km 멀리있는 고속도로를 타는 편이 더 빠를 수 있다.
- 이해를 위한 리팩터링: 코드를 이해하기 쉽게 만들기
  - 코드를 수정하려면 먼저 그 코드가 하는 일을 파악해야한다.
  - 코드의 의도가 더 명확하게 드러나도록 만들 수 있는지 리팩터링한 후, 더 깊은 수준까지 이해할 수 있다. 
  - **복잡한 코드 아래 숨어 있는 다양한 기회를 발견할 수 있다.**
- 쓰레기 줍기 리팩터링
  - 쓰레기가 나뒹굴게 방치해서 나중에 일을 방해하도록 내버려두는 것은 좋지 않다.
  - 간단히 수정할 수 있는 것은 즉시 고치고, 시간이 좀 걸리는 일은 짧은 메모만 남긴 뒤, 하던 일을 끝내고 나서 처리한다.
- 계획된 리팩터링과 수시로 하는 리팩터링
  - 리팩터링 시간을 일정에 따로 잡아두지 않고, 다른 일을 하는 중에 처리한다.
  - 리팩터링은 계획하여 하는 것이 아닌 **수시로 프로그래밍을 하면서 기회가 될 때마다 해야한다**.
- 오래 걸리는 리팩터링
  - 라이브러리 교체, 골치 아픈 의존성 정리 등 대규모 리팩터링도 있다.
  - 이런 리팩터링은 시간을 충분히 내서 천천히 해결하는 편이 효과적일 때가 많다.
- 코드 리뷰에 리팩터링 활용하기
  - 코드 리뷰는 개발팀 전체에 지식을 전파하는 데 좋다.
  - 내 눈에는 명확한 코드가 다른 팀원에게는 그렇지 않을 수 있다.
  - 리뷰 진행시 작성자와 참석하여 진행하는 것이 효과적이며, 함게 리팩터링을 하게되면 자연스럽게 **짝 프로그래밍(Pair programming)** 이 된다.
- 관리자에게는 뭐라고 말해야 할까?
  - 리팩터링이 아닌 어설픈 재구성 작업을 하면서 코드베이스를 오히려 망가뜨리는 모습을 보면 불신이 증폭된다.
  - 프로 개발자의 역할은 효과적인 소프트웨어를 최대한 빨리 만드는 것이다.
  - 리팩터링은 이 목표를 달성하는 데 도움이 되는 활동이다.
- 리팩터링하지 말아야 할 때
  - 지저분한 코드를 발견해도 굳이 수정할 필요가 없다면 리팩터링하지 않는다.
    - 외부 API 다루듯 호출해서 쓰는 경우
    - 처음부터 새로 작성하는게 쉬운 경우

## 2.5 리팩터링 시 고려할 문제

> 무언가를 언제 어디에 적용할지 판단하려면 손익을 제대로 이해해야 한다.

- 새 기능 개발 속도 저하
  - 리팩터링의 궁극적인 목적은 개발 속도를 높이는 데 있다.
  - 대부분은 리팩터링을 더 자주 하도록 노력해야 한다.
  - 코드베이스가 건강하면 기존 코드를 새로운 방식으로 조합하기 쉬워서 복잡한 새 기능을 더 빨리 추가할 수 있다.
  - 리팩터링의 본질은 코드베이스를 예쁘게 꾸미는 데 있지 않다. **경제적인 이유로 하는 것이다**.
- 코드 소유권
  - 코드 소유권을 작은 단위로 나눠 엄격히 관리하면 리팩터링에 방해가 될 수 있다.
  - 코드의 소유권을 팀에 둔다면 해당 팀원은 누구나 코드를 수정할 수 있다.
  - 각자가 책임지는 영역은 변경사항을 관리하라는 뜻이지, 다른 사람이 수정하지 못하게 막으라는 뜻이 아니다.
- 브랜치
  - feature 브랜치들이 독립적으로 개발되는 기간이 길어질수록 merge가 복잡해진다.
  - 브랜치의 통합 주기를 2~3일 단위로 짧게 관리하는 지속적 통합(CI), 트렁크 기반 개발(TBD)를 제안한다.
  - CI와 리팩터링을 합쳐서 [익스트림 프로그래밍(XP)](https://namu.wiki/w/%EC%9D%B5%EC%8A%A4%ED%8A%B8%EB%A6%BC%20%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D)이 탄생
- 테스팅
  - 테스트 코드가 있다면 리팩터링 과정에서 발생하는 오류를 재빨리 잡을 수 있다.
  - CI에 통합된 테스트는 XP의 권장사항이자 CD의 핵심이기도 하다.
- 레거시 코드
  - 대규모 레거시 시스템을 테스트 코드 없이 명료하게 리팩터링하기는 어렵다.
  - 테스트를 갖추고 있더라도 단번에 리팩터링하는 것은 낙관적이지 않다.
  - 코드의 한 부분을 훑고 넘어갈 때마다 조금식 리팩터링하면 개선한다.
- 데이터베이스
  - 데이터베이스 리팩터링은 프로덕션 환경에서 여러 단계로 나눠서 릴리즈하는 것이 대체로 좋다.
  - 필드 추가 -> 기존 필드, 새 필드 동시 업데이트 -> 새 필드를 사용하도록 조금씩 수정 -> 기존 필드 삭제

## 2.6 리팩터링, 아키텍처, 애그니(YAGNI)

리팩터링이 아키텍처에 미치는 실질적인 효과는 요구사항 변화에 자연스럽게 대응하도록 코드베이스를 잘 설계해준다는 데 있다.   
[YAGNI(you aren't going to need it)](https://ko.wikipedia.org/wiki/YAGNI): 어느 부분에 유연성이 필요하고 변화에 잘 대응할 수 있을지 미래를 예측하지 않고, 현재까지 파악한 요구사항만을 해결하는 소프트웨어를 구축한다.

## 2.7 리팩터링과 소프트웨어 개발 프로세스

테스트코드, 지속적 통합, 리팩터링 세 기법을 이용하여 YAGNI 설계 방식으로 개발을 진행할 수 있다.

## 2.8 리팩터링과 성능
**직관적 설계 vs 성능** 은 중요한 주제다.   
성능을 개선하기 위해 코드를 수정하다보면 다루기 어려운 형태로 변하기 쉽고, 개발이 더뎌진다.   

대부분의 프로그램은 전체 코드 중 극히 일부에서 대부분의 시간을 소비한다.   
따라서 코드 전체를 고르게 최적화한다면 그 중 **90%는 효과가 거의 없기 때문에 시간 낭비**인 셈이다.

의도적으로 성능 최적화에 돌입하기 전까지는 성능에 신경 쓰지 않고 코드를 다루기 쉽게 만드는데 집중한다.   
그러다 최적화 단계가 되면 구체적인 절차를 따라 튜닝한다.   
1. 프로파일러로 프로그램의 성능을 분석
2. 시간과 공간을 많이 잡아먹는 지점 파악
3. 해당 지점 개선

리팩터링할 때처럼 최적화를 위한 수정도 작은 단계로 나눠서 진행한다.   
각 단계마다 컴파일, 테스트를 거치며 사용자가 만족하는 성능에 도달할 때까지 최적화한다.

리팩터링을 잘 해두면 최적화에 두 가지 면에서 도움이 된다.
- 기능 추가가 빨리 끝나서 성능에 집중할 시간을 더 벌 수 있다.
- 리팩터링이 잘 되어 있는 프로그램은 성능을 더 세밀하게 분석할 수 있다.

## 2.9 리팩터링의 유래

1980년 스몰토크를 활용한 개발을 할때, 워드와 켄트의 XP와 리팩터링 개념이 등장하고 이러한 개념들이 스몰토크 개발 문화에 중요한 요소로 자리잡았다.   
이러한 개념(리팩터링)이 현재 업계에서도 잘 받아들여지고 사용되고 있다.

## 2.10 리팩터링 자동화
자동 리팩터링을 제대로 구현하려면 텍스트 상태가 아닌 구문 트리로 해석하여 다뤄야한다.   
IntelliJ, VSCode 등의 텍스트 에디터에서는 자동 리팩터링을 지원한다.   
[LSP(Language Server Protocol)](https://langserver.org/): 구문 트리를 구성해서 텍스트 에디터에 API 형태로 제공하는 소프트웨어 



